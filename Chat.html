<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elion Chat</title>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
:root {
  --main-bg: #111;
  --sidebar-bg: #1a1a1a;
  --header-bg: #1a1a1a;
  --input-bg: #222;
  --text-color: #fff;
  --secondary-color: #aaa;
  --border-color: #333;
  --accent-color: #0078ff;
  --accent-text-color: #000;
  --user-bubble-bg: #333;
}

body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: flex;
  height: 100vh;
  overflow: hidden;
  background: var(--main-bg);
  color: var(--text-color);
}

.sidebar {
  width: 200px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  padding: 10px;
  transition: width 0.3s, background 0.3s;
}
.sidebar.closed {
  width: 60px;
  align-items: center;
}
.sidebar button {
  border: none;
  background: none;
  cursor: pointer;
  margin: 8px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
  padding: 8px;
  border-radius: 6px;
  width: 100%;
  color: var(--text-color);
  transition: gap 0.3s, padding 0.3s, background 0.2s;
}
.sidebar button:hover { background: var(--border-color); }
.sidebar.closed button {
  gap: 0;
  padding: 8px 0;
  justify-content: center;
}
.sidebar button span {
  transition: opacity 0.3s;
  pointer-events: none;
}
.sidebar.closed button span {
  opacity: 0;
  pointer-events: none;
}
.sidebar button i {
    width: 18px;
    height: 18px;
}

.chat-list {
  list-style: none;
  padding: 0;
  margin: 10px 0;
  width: 100%;
  overflow-y: auto;
}
.chat-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px;
  margin: 4px 0;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
  background: transparent;
  transition: background 0.2s;
  position: relative;
}
.chat-item:hover, .chat-item.selected { background: var(--border-color); }
.chat-item-name { color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; }

.chat-options-btn {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  padding: 4px;
}
.chat-options-btn:hover {
  background: var(--border-color);
  border-radius: 50%;
}

.chat-options-menu {
  position: absolute;
  top: 50%;
  right: -5px;
  transform: translateY(-50%);
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 6px;
  padding: 5px;
  display: none;
  flex-direction: column;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}
.chat-options-menu.open {
  display: flex;
}
.chat-options-menu button {
  width: 100%;
  background: none;
  border: none;
  color: var(--text-color);
  padding: 8px 12px;
  text-align: left;
  cursor: pointer;
  font-size: 14px;
}
.chat-options-menu button:hover {
  background: var(--border-color);
  border-radius: 4px;
}

.delete-btn-red {
    color: red !important;
}

.chat-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--main-bg);
  transition: background 0.3s;
  padding: 0;
}

.header {
  padding: 10px 20px;
  background: var(--header-bg);
  border-bottom: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
  transition: background 0.3s;
}
.header button {
  background: none;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 16px;
  color: var(--text-color);
}
.header-actions {
  margin-left: auto;
  display: flex;
  gap: 10px;
}

.model-dropdown {
  position: absolute;
  top: 50px;
  left: 20px;
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  display: none;
  flex-direction: column;
  width: 250px;
  z-index: 30;
  color: var(--text-color);
}
.model-dropdown.open { display: flex; }
.model-option { padding: 10px; cursor: pointer; border-bottom: 1px solid var(--border-color); color: var(--text-color); }
.model-option:hover { background: var(--border-color); }

.chat-box {
  flex: 1;
  padding: 15px 20px;
  overflow-y: auto;
  position: relative;
}
.message {
  margin-bottom: 10px;
}
.message.user {
    display: flex;
    justify-content: flex-end;
}
.message.user .bubble {
    background: var(--user-bubble-bg);
    color: var(--text-color);
    padding: 10px 15px;
    border-radius: 18px;
    border-bottom-right-radius: 4px;
    max-width: 80%;
    word-wrap: break-word;
}
.message.bot { color: var(--text-color); }

.image-container {
  margin-top: 10px;
  text-align: center;
}
.image-container img {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.tts-button {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  margin-left: 5px;
  padding: 5px;
  vertical-align: middle;
}

#scroll-to-bottom-btn {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background-color: rgba(26, 26, 26, 0.7);
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}
#scroll-to-bottom-btn.visible {
  opacity: 1;
  pointer-events: auto;
}
#scroll-to-bottom-btn i {
  color: var(--text-color);
}

.loader {
  border: 4px solid var(--secondary-color);
  border-top: 4px solid var(--accent-color);
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  margin: 10px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.image-loader {
    width: 200px;
    height: 200px;
    border: 4px solid var(--secondary-color);
    border-top: 4px solid var(--accent-color);
    border-radius: 12px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}

.suggestions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 5px 0 15px 0;
}
.suggestions button {
  background: var(--input-bg);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
}
.suggestions button:hover { background: var(--border-color); }

.action-icons { display: flex; gap: 6px; margin-left: 5px; }
.action-icons button {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  font-size: 16px;
}
.action-icons button:hover { color: var(--accent-color); }

.input-area {
  padding: 10px 15px;
  background: var(--sidebar-bg);
  display: flex;
  flex-direction: column;
  gap: 6px;
  transition: background 0.3s;
}
.input-top {
  display: flex;
  align-items: center;
  gap: 6px;
}
.input-top textarea {
  flex: 1;
  border-radius: 20px;
  padding: 10px 15px;
  background: var(--input-bg);
  color: var(--text-color);
  border: 1px solid var(--border-color);
  outline: none;
  resize: none;
  font-size: 15px;
  transition: background 0.3s, border-color 0.3s, color 0.3s;
}
.file-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: var(--text-color);
  cursor: pointer;
}
.file-btn:hover { color: var(--accent-color); }
.send-btn {
  background: white;
  border-radius: 50%;
  padding: 10px;
  cursor: pointer;
  color: black;
}
.send-btn:hover { background: #eee; }

.voice-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: var(--text-color);
  cursor: pointer;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.voice-btn:hover {
  color: var(--accent-color);
}

@keyframes pulse {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.2);
    }
    100% {
        transform: scale(1);
    }
}

.voice-btn.listening {
    color: red;
    animation: pulse 1s infinite;
}

.input-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}
.note-btn {
  background: orange;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.note-btn:hover { background: darkorange; }
.gemini-btn {
  background: var(--accent-color);
  color: var(--accent-text-color);
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.gemini-btn:hover { background: #005bb5; }

#noteEditor {
  display: none;
  margin-top:10px;
  border:1px solid var(--border-color);
  border-radius:8px;
  padding:10px;
  background:var(--input-bg);
}
#noteEditor input, #noteEditor textarea {
  width:100%;
  padding:8px;
  border-radius:6px;
  border:1px solid var(--border-color);
  margin-bottom:6px;
  background: var(--sidebar-bg);
  color: var(--text-color);
}
#noteEditor button {
  background: orange;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}
#noteEditor button:hover { background: darkorange; }

.feedback-buttons {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

.feedback-buttons button {
    background: var(--input-bg);
    color: var(--text-color);
    border: none;
    border-radius: 50%;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feedback-buttons button:hover {
    background: var(--border-color);
}
.feedback-buttons i {
  width: 16px;
  height: 16px;
}
.sidebar button i {
    width: 18px;
    height: 18px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(5px);
  padding-top: 60px;
}
.modal-content {
  background-color: var(--sidebar-bg);
  margin: 5% auto;
  padding: 20px;
  border: 1px solid var(--border-color);
  width: 80%;
  max-width: 400px;
  border-radius: 12px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.5);
  color: var(--text-color);
  position: relative;
}
.modal-content h3 {
  margin-top: 0;
  color: var(--text-color);
}
.modal-content p {
  color: var(--secondary-color);
}
.modal-content .price {
  font-size: 2em;
  font-weight: bold;
  color: var(--text-color);
  text-align: center;
  margin: 20px 0;
}
.modal-content input {
  width: calc(100% - 20px);
  padding: 10px;
  margin-bottom: 10px;
  border: 1px solid var(--border-color);
  background: var(--input-bg);
  color: var(--text-color);
  border-radius: 8px;
}
.modal-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
.modal-buttons .confirm-btn {
  background-color: var(--accent-color);
  color: var(--accent-text-color);
}
.modal-buttons .cancel-btn {
  background-color: var(--border-color);
  color: var(--text-color);
}
.modal-content .start-btn {
  width: 100%;
  padding: 15px;
  font-size: 1.2em;
  border: none;
  border-radius: 8px;
  background-color: var(--accent-color);
  color: white;
  cursor: pointer;
}
.modal-content .start-btn:hover {
  background-color: #005bb5;
}

.warning-subtitle {
    font-size: 12px;
    color: var(--secondary-color);
    text-align: center;
    margin-top: 5px;
}

.share-buttons-container {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
}

.share-buttons-container button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
}

.share-buttons-container button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.share-buttons-container button.whatsapp {
    background-color: #25d366;
}
.share-buttons-container button.messenger {
    background-color: #0078ff;
}
.share-buttons-container button.x-twitter {
    background-color: #1DA1F2;
}

.share-buttons-container svg {
    width: 32px;
    height: 32px;
    fill: white;
}

.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: red;
    font-size: 24px;
    cursor: pointer;
    line-height: 1;
}

</style>
</head>
<body class="theme-noir">

<div class="sidebar" id="sidebar">
  <button onclick="toggleSidebar()"><i data-lucide="menu"></i><span> Menu</span></button>
  <button onclick="newChat()"><i data-lucide="plus"></i><span> Nouveau Chat</span></button>
  <ul id="chat-list" class="chat-list"></ul>
</div>

<div class="chat-container">
  <div class="header">
    <button onclick="toggleModelMenu()">
      ✨ Elion <i data-lucide="chevron-down"></i>
    </button>
    <div class="header-actions">
    </div>
    <div id="modelMenu" class="model-dropdown">
      <div class="model-option" onclick="selectModel('Standard')">
        <div class="model-title">Elion Standard</div>
        <div class="model-desc">Idéal pour bavardage et tâches quotidiennes</div>
      </div>
      <div class="model-option" onclick="selectModel('Pro')">
        <div class="model-title">Elion Pro</div>
        <div class="model-desc">Plus évolué pour plus de tâches (Bientôt)</div>
      </div>
    </div>
  </div>

  <div id="chatBox" class="chat-box">
    <button id="scroll-to-bottom-btn" onclick="scrollToBottom()"><i data-lucide="chevron-down"></i></button>
  </div>

  <div class="input-area">
    <div class="input-top">
      <input type="file" id="fileInput" accept="text/*" style="display: none;">
      <button class="file-btn" title="Importer un fichier" onclick="document.getElementById('fileInput').click()"><i data-lucide="plus"></i></button>
      <textarea id="userInput" placeholder="Demander à Elion..." rows="1"></textarea>
      <button class="voice-btn" onclick="startVoiceRecognition()"><i data-lucide="mic"></i></button>
      <button class="send-btn" onclick="sendMessage()"><i data-lucide="arrow-up"></i></button>
    </div>
    <div class="warning-subtitle">
        Elion utilise l'IA. Faites Attention lorsque vous voyez ses réponses elles peuvent etres fausses
    </div>
    <div class="input-bottom">
      <button class="note-btn" onclick="toggleNoteEditor()"><i data-lucide="edit-3"></i> Note</button>
    </div>

    <div id="noteEditor">
      <input id="noteTitle" type="text" placeholder="Titre de la note">
      <textarea id="noteContent" rows="3" placeholder="Écrire la note ici..."></textarea>
      <button onclick="saveNote()">Enregistrer</button>
    </div>
  </div>
</div>

<div id="renameModal" class="modal">
  <div class="modal-content">
    <button class="modal-close-btn" onclick="closeModal('renameModal')">&times;</button>
    <h3>Renommer le chat</h3>
    <input type="text" id="renameInput" placeholder="Nouveau nom">
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeModal('renameModal')">Annuler</button>
      <button class="confirm-btn" onclick="performRename()">Renommer</button>
    </div>
  </div>
</div>

<div id="proSubscriptionModal" class="modal">
  <div class="modal-content">
    <button class="modal-close-btn" onclick="closeModal('proSubscriptionModal')">&times;</button>
    <h3>Abonnement Elion Pro</h3>
    <p>Passez au niveau supérieur et libérez tout le potentiel d'Elion Pro avec des fonctionnalités avancées et une vitesse de génération encore plus rapide !</p>
    <div class="price">9.99€/mois</div>
    <button class="start-btn" onclick="openModal('paymentAlertModal'); closeModal('proSubscriptionModal');">Commencer</button>
  </div>
</div>

<div id="paymentAlertModal" class="modal">
  <div class="modal-content">
    <button class="modal-close-btn" onclick="closeModal('paymentAlertModal')">&times;</button>
    <h3>Information</h3>
    <p>La fonctionnalité de paiement sera bientôt disponible. Merci de votre intérêt !</p>
    <div class="modal-buttons">
      <button class="confirm-btn" onclick="closeModal('paymentAlertModal')">OK</button>
    </div>
  </div>
</div>

<div id="shareModal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeModal('shareModal')">&times;</button>
        <h3>Partager la réponse</h3>
        <div class="share-buttons-container">
            <button class="whatsapp" onclick="shareToService('whatsapp')">
                <svg viewBox="0 0 24 24" width="24" height="24" style="fill: white;"><path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm3.628 14.15l-.2-.312c-.11-.17-.468-.31-.968-.5c-.5-.19-.462-.31-.64-.546-.178-.236-.614-.775-.826-.953-.212-.178-.46-.226-.65-.226-.19 0-.41.07-.63.29-.22.22-.848.847-.848 1.968 0 1.12.868 2.27 1.258 2.76.39.49.83.65 1.706.918.428.13 1.63.668 2.378.895.747.226 1.134.19 1.32-.016.188-.205.818-.674.93-.112-.22.112-.41.08-.546-.03-.136-.2-.212-.422-.31zM9.98 7.37c.334-.73.666-.826.96-.826.294 0 .546 0 .74.226.194.226.546.614.74.84.194.226.31.294.5.488.19.194.81.74 1.2.92.39.18 1.05.74.945 1.58-.105.84-.716 1.41-1.106 1.58-.39.17-1.46.25-2.07-.112-.61-.362-1.02-.91-1.354-1.3-.334-.39-.63-.826-.924-1.218-.294-.39-.588-.74-.588-1.217 0-.476.332-.73.666-1.08z"/></svg>
            </button>
            <button class="messenger" onclick="shareToService('messenger')">
                <svg viewBox="0 0 24 24" width="24" height="24" style="fill: white;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c2.476 0 4.77-1.124 6.323-2.924a.997.997 0 0 0-.074-.08c-.02-.02-.04-.04-.06-.06a.999.999 0 0 0-.84-.256c-1.378.196-2.79.296-4.229.296-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9c0 1.455-.316 2.87-1.016 4.16a.999.999 0 0 0 .153.136c.02.02.04.04.06.06a.999.999 0 0 0 .84.256c1.378-.196 2.79-.296 4.229-.296 4.962 0 9-4.038 9-9s-4.038-9-9-9zm-1.874 12.193a.997.997 0 0 0-.12-.048c-.02-.008-.04-.016-.06-.024a.999.999 0 0 0-.84-.256c-1.378.196-2.79.296-4.229.296-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9c0 1.455-.316 2.87-1.016 4.16a.999.999 0 0 0 .153.136c.02.02.04.04.06.06a.999.999 0 0 0 .84.256c1.378-.196 2.79-.296 4.229-.296 4.962 0 9-4.038 9-9s-4.038-9-9-9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c2.476 0 4.77-1.124 6.323-2.924a.997.997 0 0 0-.074-.08c-.02-.02-.04-.04-.06-.06a.999.999 0 0 0-.84-.256c-1.378.196-2.79.296-4.229.296-4.962 0-9-4.038-9-9s4.038-9-9-9zm-1.874 12.193a.997.997 0 0 0-.12-.048c-.02-.008-.04-.016-.06-.024a.999.999 0 0 0-.84-.256c-1.378.196-2.79.296-4.229.296-4.962 0-9-4.038-9-9s4.038-9 9-9 9 4.038 9 9c0 1.455-.316 2.87-1.016 4.16a.999.999 0 0 0 .153.136c.02.02.04.04.06.06a.999.999 0 0 0 .84.256c1.378-.196 2.79-.296 4.229-.296 4.962 0 9-4.038 9-9s-4.038-9-9-9z"/></svg>
            </button>
            <button class="x-twitter" onclick="shareToService('x-twitter')">
                <svg viewBox="0 0 1200 1227" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1227H105.866L459.331 733.773L774.672 1227H1200L714.163 519.284ZM500.644 698.344L403.425 575.148L101.691 970.19L198.89 1093.39L500.644 698.344ZM983.479 253.947L884.78 141.65L200.244 975.257L299.004 1087.55L983.479 253.947Z" fill="white"/></svg>
            </button>
        </div>
    </div>
</div>

<script>
let chatHistory = {};
let currentChatId = null;
let chatCounter = 1;
let messageToShare = "";

let suggestionsList = [
  {question:"Que peux-tu faire pour moi ?", text: "Je suis un modèle de langage et je peux vous aider avec des questions, de la créativité et des tâches."},
  {question:"c'est quoi Elion Pro ?", text: "Elion Pro est une version améliorée de Elion avec des fonctionnalités avancées et une vitesse de génération plus rapide."}
];

const API_KEY = "";
const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";

function toggleSidebar() { document.getElementById("sidebar").classList.toggle("closed"); }
function toggleModelMenu() { document.getElementById("modelMenu").classList.toggle("open"); }
function selectModel(model) {
  document.getElementById("modelMenu").classList.remove("open");
  if (model === 'Pro') {
    openModal('proSubscriptionModal');
  } else {
    appendMessage("📌 Elion Standard est uniquement disponible pour le moment.");
  }
}

function saveMessageToHistory(content, type="bot", isImage=false, isTTS=false) {
  if (currentChatId) {
    if (!chatHistory[currentChatId]) {
      chatHistory[currentChatId] = [];
    }
    chatHistory[currentChatId].push({ text: content, type: type, isImage: isImage, isTTS: isTTS });
  }
}

function appendMessage(content, type="bot", isImage=false, isTTS=false, save=true) {
  const box = document.getElementById('chatBox');
  const msg = document.createElement('div');
  msg.className = `message ${type}`;

  if (isImage) {
    const imgContainer = document.createElement('div');
    imgContainer.className = 'image-container';
    const img = document.createElement('img');
    img.src = content;
    img.alt = "Image générée par l'IA";
    imgContainer.appendChild(img);
    msg.appendChild(imgContainer);
  } else {
    if (type === 'user') {
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = content;
      msg.appendChild(bubble);
    } else {
      const contentSpan = document.createElement('span');
      contentSpan.textContent = content;
      msg.appendChild(contentSpan);
    }
  }

  if (type === 'bot') {
    const feedbackButtons = document.createElement('div');
    feedbackButtons.className = 'feedback-buttons';

    const likeBtn = document.createElement('button');
    likeBtn.title = "Bonne réponse";
    likeBtn.innerHTML = `<i data-lucide="thumbs-up"></i>`;
    likeBtn.onclick = () => handleFeedback('like');

    const dislikeBtn = document.createElement('button');
    dislikeBtn.title = "Mauvaise réponse";
    dislikeBtn.innerHTML = `<i data-lucide="thumbs-down"></i>`;
    dislikeBtn.onclick = () => handleFeedback('dislike');

    const copyBtn = document.createElement('button');
    copyBtn.title = "Copier la réponse";
    copyBtn.innerHTML = `<i data-lucide="clipboard"></i>`;
    copyBtn.onclick = () => copyMessage(content);

    const shareBtn = document.createElement('button');
    shareBtn.title = "Partager";
    shareBtn.innerHTML = `<i data-lucide="share-2"></i>`;
    shareBtn.onclick = () => shareMessage(content);
    
    const ttsBtn = document.createElement('button');
    ttsBtn.className = 'tts-button';
    ttsBtn.innerHTML = `<i data-lucide="volume-2"></i>`;
    ttsBtn.title = "Lire à voix haute";
    ttsBtn.onclick = () => playTTS(content);

    feedbackButtons.appendChild(likeBtn);
    feedbackButtons.appendChild(dislikeBtn);
    feedbackButtons.appendChild(copyBtn);
    feedbackButtons.appendChild(shareBtn);
    feedbackButtons.appendChild(ttsBtn);

    msg.appendChild(feedbackButtons);
  }

  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
  if(save) saveMessageToHistory(content, type, isImage, isTTS);
}

// Fonction utilitaire pour décoder la chaîne Base64 en un tableau de tampons
function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// Fonction utilitaire pour convertir les données PCM en un fichier WAV jouable
// Le modèle Gemini TTS retourne de l'audio PCM 16 bits non compressé
function pcmToWav(pcmData, sampleRate) {
    const pcmView = new Int16Array(pcmData);
    const pcmLength = pcmView.length;
    const buffer = new ArrayBuffer(44 + pcmLength * 2);
    const view = new DataView(buffer);
    
    // Écriture de l'en-tête WAV
    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    let offset = 0;
    writeString(view, offset, 'RIFF'); offset += 4; // ChunkID
    view.setUint32(offset, 36 + pcmLength * 2, true); offset += 4; // ChunkSize
    writeString(view, offset, 'WAVE'); offset += 4; // Format
    writeString(view, offset, 'fmt '); offset += 4; // Subchunk1ID
    view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size
    view.setUint16(offset, 1, true); offset += 2; // AudioFormat
    view.setUint16(offset, 1, true); offset += 2; // NumChannels
    view.setUint32(offset, sampleRate, true); offset += 4; // SampleRate
    view.setUint32(offset, sampleRate * 2, true); offset += 4; // ByteRate
    view.setUint16(offset, 2, true); offset += 2; // BlockAlign
    view.setUint16(offset, 16, true); offset += 2; // BitsPerSample
    writeString(view, offset, 'data'); offset += 4; // Subchunk2ID
    view.setUint32(offset, pcmLength * 2, true); offset += 4; // Subchunk2Size

    // Écriture des données PCM
    for (let i = 0; i < pcmLength; i++) {
        view.setInt16(offset + i * 2, pcmView[i], true);
    }

    return new Blob([view], { type: 'audio/wav' });
}

async function playTTS(text) {
    const audio = new Audio();
    const payload = {
        contents: [{
            parts: [{ text: text }]
        }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                voiceConfig: {
                    prebuiltVoiceConfig: { voiceName: "Rasalgethi" } // Using a different voice for a more distinct sound
                }
            }
        },
        model: TTS_MODEL
    };
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            throw new Error(`Erreur réseau: ${response.status}`);
        }
        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);
            audio.src = audioUrl;
            audio.play();
        } else {
            console.error("Données audio invalides ou manquées.");
        }
    } catch (error) {
        console.error("Erreur lors de la lecture audio:", error);
    }
}

function newChat(event) {
    if (event) { event.preventDefault(); }
    if (currentChatId) {
    }

    chatCounter++;
    const newChatId = `chat-${chatCounter}`;
    currentChatId = newChatId;
    chatHistory[newChatId] = [];

    const chatList = document.getElementById('chat-list');
    const newChatItem = document.createElement('li');
    newChatItem.id = newChatId;
    newChatItem.className = 'chat-item selected';
    newChatItem.onclick = () => selectChat(newChatId);
    newChatItem.innerHTML = `
        <span class="chat-item-name">Nouveau Chat</span>
        <button class="chat-options-btn" onclick="event.stopPropagation(); toggleChatOptions('${newChatId}')"><i data-lucide="more-vertical"></i></button>
        <div class="chat-options-menu" id="options-${newChatId}">
            <button onclick="event.stopPropagation(); openModal('renameModal', '${newChatId}')">Renommer</button>
            <button class="delete-btn-red" onclick="event.stopPropagation(); handleDelete('${newChatId}')">Supprimer</button>
        </div>
    `;
    
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selected'));
    chatList.prepend(newChatItem);

    document.getElementById('chatBox').innerHTML = '';
    
    appendWelcomeMessage();
    appendSuggestions();
    lucide.createIcons();
}

function appendWelcomeMessage() {
    const welcomeText = `Bonjour (nom de l'utilisateur), je me nomme Elion. Je suis là pour parler avec vous sur Sonic.

Actuellement, je peux :
- Raconter 120 blagues
- 20 histoires
- Générer du texte
- Faire des notes
- Vous donner des solutions grâce aux recherches google`;
    appendMessage(welcomeText, "bot");
}

function selectChat(id) {
    document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selected'));
    document.getElementById(id).classList.add('selected');
    currentChatId = id;

    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = '';
    
    const messages = chatHistory[id] || [];
    if (messages.length > 0) {
        messages.forEach(msg => appendMessage(msg.text, msg.type, msg.isImage, msg.isTTS, false));
    } else {
        appendSuggestions();
    }
}

function toggleChatOptions(chatId) {
    const menu = document.getElementById(`options-${chatId}`);
    document.querySelectorAll('.chat-options-menu').forEach(m => m.classList.remove('open'));
    menu.classList.toggle('open');
}

function handleRename(id, newName) {
    const chatItem = document.getElementById(id);
    const chatNameSpan = chatItem.querySelector('.chat-item-name');
    if (chatNameSpan) {
        chatNameSpan.textContent = newName;
    }
}

function handleDelete(id) {
    const chatItem = document.getElementById(id);
    if (chatItem) {
        chatItem.remove();
        delete chatHistory[id];
        console.log(`Chat ${id} a été supprimé.`);
        if (currentChatId === id) {
            newChat();
        }
    }
}

function openModal(modalId, chatId = null) {
  const modal = document.getElementById(modalId);
  modal.style.display = 'block';
  if (chatId) {
    currentChatToRename = chatId;
    if (modalId === 'renameModal') {
      const chatName = document.getElementById(chatId).querySelector('.chat-item-name').textContent;
      document.getElementById('renameInput').value = chatName;
    }
  }
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  currentChatToRename = null;
}

function performRename() {
  const newName = document.getElementById('renameInput').value;
  if (newName && currentChatToRename) {
    handleRename(currentChatToRename, newName);
    closeModal('renameModal');
  }
}

async function sendMessage() {
  const userInput = document.getElementById('userInput');
  const userText = userInput.value.trim();
  if (!userText) return;

  appendMessage(userText, "user");
  userInput.value = '';
  showLoader();

  const chat = chatHistory[currentChatId].map(msg => ({
    role: msg.type === "user" ? "user" : "model",
    parts: [{ text: msg.text }]
  }));
  const payload = {
    contents: chat,
    tools: [ { "google_search": {} } ],
    systemInstruction: {
        parts: [{ text: "Vous êtes un assistant IA nommé Elion. Répondez aux questions avec des informations complètes et détaillées, en utilisant des citations lorsque c'est nécessaire. Si vous ne pouvez pas répondre à la question, exprimez-vous poliment." }]
    }
  };
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`;
  
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
        hideLoader();
        appendMessage(`Erreur de génération : ${response.statusText}`);
        throw new Error(`Erreur réseau: ${response.status}`);
    }

    const result = await response.json();
    let botResponse = result?.candidates?.[0]?.content?.parts?.[0]?.text;
    const groundingMetadata = result?.candidates?.[0]?.groundingMetadata;

    if (groundingMetadata && groundingMetadata.groundingAttributions) {
        groundingMetadata.groundingAttributions.forEach(attribution => {
            if (attribution.web?.uri) {
                const url = attribution.web.uri;
                const title = attribution.web.title || "Lien";
                botResponse += `\n\nSource: [${title}](${url})`;
            }
        });
    }

    hideLoader();
    if (botResponse) {
        appendMessage(botResponse, "bot", false, true);
    } else {
        appendMessage("Désolé, je ne peux pas générer une réponse pour le moment.");
    }
  } catch (error) {
    hideLoader();
    console.error('Erreur:', error);
    appendMessage("Désolé, une erreur inattendue est survenue. Veuillez vérifier votre clé d'API ou les autorisations.");
  }
}

function showLoader() {
  const box = document.getElementById('chatBox');
  const loaderDiv = document.createElement('div');
  loaderDiv.className = 'message bot loader-container';
  loaderDiv.innerHTML = '<div class="loader"></div>';
  box.appendChild(loaderDiv);
  box.scrollTop = box.scrollHeight;
}

function hideLoader() {
  const box = document.getElementById('chatBox');
  const loader = box.querySelector('.loader-container');
  if (loader) {
    loader.remove();
  }
}

function handleFeedback(type) {
  if (type === 'like') {
    console.log("Feedback positif reçu.");
  } else {
    console.log("Feedback négatif reçu.");
  }
}

async function copyMessage(text) {
  try {
    await navigator.clipboard.writeText(text);
    console.log('Texte copié dans le presse-papiers.');
  } catch (err) {
    console.error('Échec de la copie:', err);
    // Fallback for browsers that do not support the modern clipboard API
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
      document.execCommand('copy');
      console.log('Texte copié via execCommand.');
    } catch (err) {
      console.error('Échec de la copie via execCommand:', err);
    }
    document.body.removeChild(textarea);
  }
}

function shareMessage(text) {
    messageToShare = text;
    openModal('shareModal');
}

function shareToService(service) {
    const encodedText = encodeURIComponent(messageToShare);
    closeModal('shareModal');
    if (service === 'whatsapp') {
        window.open(`https://wa.me/?text=${encodedText}`, '_blank');
    } else if (service === 'messenger') {
        const messengerUrl = `https://m.me/`;
        window.open(messengerUrl, '_blank');
    } else if (service === 'x-twitter') {
        window.open(`https://twitter.com/intent/tweet?text=${encodedText}`, '_blank');
    }
}

function toggleNoteEditor() {
    const noteEditor = document.getElementById('noteEditor');
    noteEditor.style.display = noteEditor.style.display === 'flex' ? 'none' : 'flex';
}

function saveNote() {
    const title = document.getElementById('noteTitle').value;
    const content = document.getElementById('noteContent').value;
    if (title || content) {
        console.log("Note enregistrée:", { title, content });
        document.getElementById('noteTitle').value = '';
        document.getElementById('noteContent').value = '';
        toggleNoteEditor();
    }
}

function appendSuggestions() {
  const chatBox = document.getElementById('chatBox');
  const suggestionsDiv = document.createElement('div');
  suggestionsDiv.className = 'suggestions';
  suggestionsList.forEach(s => {
    const btn = document.createElement('button');
    btn.textContent = s.question;
    btn.onclick = () => {
        document.getElementById('userInput').value = s.text;
        sendMessage();
    };
    suggestionsDiv.appendChild(btn);
  });
  chatBox.appendChild(suggestionsDiv);
}

function scrollToBottom() {
    const chatBox = document.getElementById('chatBox');
    chatBox.scrollTop = chatBox.scrollHeight;
}

document.addEventListener('DOMContentLoaded', () => {
  const chatBox = document.getElementById('chatBox');
  const sidebar = document.getElementById("sidebar");
  if (chatBox) {
    chatBox.addEventListener('scroll', () => {
      const btn = document.getElementById('scroll-to-bottom-btn');
      const isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 100;
      if (isAtBottom) {
          btn.classList.remove('visible');
      } else {
          btn.classList.add('visible');
      }
    });
  }

  newChat();

  lucide.createIcons();
});

</script>
</body>
</html>
